# Misingi ya R

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "basics_header_close.png"))
```

Karibu!

Ukurasa huu unaainisha mambo muhimu kuhusu R. Haikusudiwi kuwa mafunzo ya kina, bali inatoa misingi ambayo inaweza kusaidia kukumbusha. Sehemu ya [Rasilimali za kujifunzia](#learning) ina vipengele vyenye mafunzo zaidi ya kina.

Sehemu za ukurasa huu zimetohorewa kwa ruhusa kutoka kwa [R4Epis project](https://r4epis.netlify.app/).

Tazama ukurasa wa [Transition to R](#transition_to_R.Rmd) kupata vidokezo vya kuhamia R kutoka STATA, SAS, or Excel.

```{r, echo=F}
# ingiza orodha ya data za ebola iliyosafishwa
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))
pacman::p_load(apyramid)
```

<!-- ======================================================= -->

## Kwa nini utumie R?

Kama ilivyoelezwa kwenye [tovuti ya mradi wa R](https://www.r-project.org/about.html), R ni lugha ya kiprogramu na kimazingira ya kompyuta ya takwimu na michoro. Ina uhodari mkubwa sana, inaweza kupanuliwa, na inaendeshwa kwa msukumo wa jamii.

**Gharama**

Ni bure kutumia R! Kuna maadili thabiti kwenye jumuiya huria na rasilimali za vyanzo huria (open-source material)

**Uzalishaji**

Kuendesha usimamizi na uchanganuzi wa data zako kupitia lugha ya kiprogramu (ikilinganishwa na Excel au zana nyingine za kubofya/za kutengeneza) huongeza **uzalishaji tena**, hurahisisha **ugunduzi wa makosa**, na kukupunguzia ukubwa wa kazi.

**Jumuiya**

Jumuiya ya watumiaji wa R ni kubwa na ni shirikishi. Vifurushi vipya na zana za kushughulikia matatizo halisi ya kimaisha hutengenezwa kila siku, na kukaguliwa na jumuiya ya watumiaji. Kama mfano mmojawapo, [R-Ladies](https://rladies.org/) ni shirika la ulimwenguni pote ambalo dhamira yake ni kukuza tofauti za kijinsia katika jumuiya ya R, na ni mojawapo ya mashirika makubwa ya watumiaji wa R. Inawezekana ina tawi karibu nawe!

## Misamiati muhimu

**RStudio** - RStudio ni kiolesura cha picha kwa mtumiaji (Graphical User Interface-GUI) kurahisisha utumiaji wa **R**. Soma zaidi [katika sehemu ya RStudio](#rstudio).

**Vifaakazi (Objects)** - Kila kitu unachohifadhi katika R - seti za data, kitendanishi, orodha ya majina ya vijiji, jumla ya idadi ya watu, hata matokeo kama vile grafu - ni *vifaakazi* ambavyo *vimepewa majina* na *vinaweza kurejelewa* katika amri za baadaye. Soma zaidi [katika sehemu ya Vifaakazi](#objects).

**Vitendakazi (Functions)** - Kikokotozi ni kitenda kazi cha msimbo ambao unachukua ingizo na kurejesha matokeo yaliyobadilishwa. Soma zaidi [katika sehemu ya Kazi](#functions).

**Vifurushi (Packages)** - Kifurushi cha R ni fungu la vitendakazi linaloweza kushirikishwa/kugawa. Soma zaidi [katika sehemu ya Vifurushi](#packages).

**Hati (Scripts)** - Hati ni chapisho linaloshikilia amri zako. Soma zaidi [katika sehemu ya Hati](#scripts)

## Rasilimali za kujifunzia {#learning}

### Rasilimali ndani ya RStudio {.unnumbered}

**Nyaraka za usaidizi**

Tafuta kichupo cha msaada ("Help") cha RStudio kwa nyaraka za vifurushi vya R na vitendakazi maalum. Hii ni ndani ya kidirisha ambacho pia kina mafaili (Files), michoro (Plots), na Vifurushi (kawaida kwenye kidirisha cha chini kulia). Kama njia ya mkato, unaweza pia kuandika alama ya kuuliza ikifuatiwa na jina la kifurushi au kikokotozi kwenye dashibodi ya R ili kufungua ukurasa wa usaidizi husika. Usijumuishe mabano.

Kwa mfano: `?filter` or `?diagrammeR`.

**Mafunzo shirikishi**

Kuna mbinu kadhaa za kujifunza R kwa njia shirikishi *ndani ya* RStudio.

RStudio yenyewe inatoa kidirisha cha Mafunzo ambacho kinatumia kifurushi cha [**learnr**](https://blog.rstudio.com/2020/02/25/rstudio-1-3-integrated-tutorials/) R. Sakinisha kifurushi hiki na ufungue mafunzo kupitia kichupo kipya cha mafunzo (Tutorial) kwenye kidirisha kilicho juu kulia ya kidirisha cha RStudio (ambacho pia kina vichupo vya mazingira (Environment) na historia (History)).

Kifurushi cha R [**swirl**](https://swirlstats.com/) hutoa kozi shirikishi katika dashibodi ya R. Sakinisha na upakie kifurushi hiki, kisha andika amri `swirl()` (mabano yawe tupu) kwenye dashibodi ya R. Utaona vidokezo vinatokea kwenye Dashibodi. Jibu kwa kuandika kwenye Dashibodi. Njia hii, itakuongoza kupitia kozi ya chaguo lako.

### Nakala za kuibia (Madesa/Cheatsheets) {.unnumbered}

Kuna "nakala za kuibia/madesa" nyingi za PDF zinazopatikana kwenye [tovuti ya RStudio](https://rstudio.com/resources/cheatsheets/), kwa mfano:

-   Makundi kamilifu (Factors) kutoka kifurushi cha **forcats**\
-   Tarehe na muda kutoka kifurushi cha **lubridate**\
-   Maneno (strings) with **stringr** package\
-   Opereshi za kujirudia kutoka kifurushi cha **purrr**\
-   Ingiza data (Data import)\
-   Desa la kubadilisha/nyambulisha data kutoka kifurushi cha **dplyr**\
-   R Markdown (kutengeneza nyaraka kama PDF, Word, Powerpoint...)\
-   Shiny (kutengeneza tovuti shirikishi)\
-   Michoro ya data kwa kutumia kifurushi cha **ggplot2**\
-   Kutengeneza ramani (GIS)\
-   Kifurushi cha **leaflet** (ramani shirikishi)\
-   Kutumia Python kwenye R (kifurushi cha **reticulate**)

Hii ni rasilimali ya R mtandaoni mahususi kwa ajili ya [Watumiaji wa Excel](https://jules32.github.io/r-for-excel-users/)

### Twitter {.unnumbered}

R ina jumuiya mahiri ya twitter ambapo unaweza kujifunza vidokezo, njia za mkato na kupashana habari - fuata akaunti hizi:

-   Follow us! [\@epiRhandbook](https://twitter.com/epirhandbook)\
-   R Function A Day [\@rfuntionaday](https://twitter.com/rfunctionaday) ni rasilimali *bora*\
-   R for Data Science [\@rstats4ds](https://twitter.com/rstats4ds?lang=en)\
-   RStudio [\@RStudio](https://twitter.com/rstudio?lang=en)\
-   RStudio Tips [\@rstudiotips](https://twitter.com/rstudiotips)\
-   R-Bloggers [\@Rbloggers](https://twitter.com/Rbloggers)\
-   R-ladies [\@RLadiesGlobal](https://twitter.com/RLadiesGlobal)\
-   Hadley Wickham [\@hadleywickham](https://twitter.com/hadleywickham?ref_src=twsrc%5Egoogle%7Ctwcamp%5Eserp%7Ctwgr%5Eauthor)

Pia:

**\#epitwitter** na **\#rstats**

### Rasilimali za bure mtandaoni {.unnumbered}

Nakala muhimu ni kitabu cha [R for Data Science](https://r4ds.had.co.nz/) kilichoandikwa na Garrett Grolemund and Hadley Wickham

Tovuti ya mradi wa [R4Epis](https://r4epis.netlify.app/) inalenga "kutengeneza zana sanifu za kusafisha data, kuchanganua na kuripoti aina za magonjwa ya mlipuko ya kawaida na dodoso za kijamii ambazo zingeweza kutumiwa na MSF katika mazingira ya dharura". Unaweza kupata nyenzo za mafunzo ya misingi ya R, vielelezo vya ripoti za RMarkdown kuhusu milipuko na dodoso, na mafunzo ya kukuwezesha kuzitengeneza.

### Lugha tofauti na kiingereza {.unnumbered}

[Nyenzo za RStudio kwa lugha ya kihispaniola](https://www.rstudio.com/collections/espanol/)

[Utangulizi kuhusu R au tidyverse kwa lugha ya kifaransa](https://juba.github.io/tidyverse/index.html)

<!-- ======================================================= -->

## Usakinishaji

### R na RStudio {.unnumbered}

**Jinsi ya kusakinisha R**

Tembelea tovuti ya <https://www.r-project.org/> kisha pakua toleo litumikalo sasa la R sahihi kwa ajili ya kompyuta yako.

**Jinsi ya kusakinisha RStudio**

Tembelea tovuti ya <https://rstudio.com/products/rstudio/download/> kisha pakua bure toleo la sasa la RStudio kwa ajili ya kompyuta yako.

**Ruhusa**\
Kumbuka kwamba unapaswa kusakinisha R na RStudio kwenye diski ambayo una ruhusa ya kusoma na kuandika. Vinginevyo, uwezo wako wa kusakinisha vifurushi vya R (tukio la mara kwa mara) utaathiriwa. Ikiwa utapata shida, jaribu kufungua RStudio kwa kubofya kitufe cha kulia na uchague "Run as administrator (Endesha kama msimamizi)". Vidokezo vingine vinaweza kupatikana katika ukurasa [R kwenye diski za mtandaoni](#network_drives).

**Jinsi ya kusasisha (update) R na RStudio**

Toleo lako la R huchapishwa kwenye dashibodi ya R wakati wa kuanza. Unaweza pia kuamuru majibu kupitia `sessionInfo()`.

Ili kusasisha R, nenda kwenye tovuti iliyotajwa hapo juu na usakinishe tena R. Vinginevyo, unaweza kutumia kifurushi cha **installr** (kwenye kompyuta aina ya Windows) kwa kuamuru `installr::updateR()`. Hii itafungua visanduku vya majibishano ili kukusaidia kupakua toleo jipya zaidi la R na kusasisha vifurushi vyako kwenye toleo jipya la R. Maelezo zaidi yanaweza kupatikana katika [hati](https://www.r-project.org/nosvn/pandoc/installr.html) ya **installr**.

Fahamu kuwa toleo la zamani la R bado litakuwepo kwenye kompyuta yako. Unaweza kutumia toleo la zamani kwa muda ("usakinishaji" wa zamani) wa R kwa kubofya kitufe cha zana "Tools" -\> "Global Options" katika RStudio na kuchagua toleo la R. Hii inaweza kuwa muhimu ikiwa unataka kutumia kifurushi ambacho hakijasasishwa kwenye toleo jipya zaidi la R.

Ili kusasisha RStudio, unaweza kwenda kwenye tovuti iliyo hapo juu na upakue upya RStudio. Chaguo jingine ni kubofya kwenye kitufe cha msaada "Help" -\> "Check for Updates" ndani ya RStudio, lakini hii inaweza isionyeshe masasisho mapya zaidi.

Ili kuona ni matoleo yapi ya R, RStudio, au vifurushi vilivyotumika wakati Kitabu hiki cha Mwongozo kilipotengenezwa, angalia ukurasa kwenye [Maelezo ya uhariri na kiufundi](#editorial_style).

### Programu nyingine ambayo *huenda* ukahitaji kusanikisha {.unnumbered}

-   TinyTeX (*kwa ajili ya kutengeneza faili za PDF kwa kutumia RMarkdown*)\
-   Pandoc (*kwa ajili ya kutengeneza faili za RMarkdown*)\
-   RTools (*kwa ajili ya kuunda vifurushi vya R*)\
-   phantomjs (*kwa ajili ya kuhifadhi picha za michoro inayotembea (animations) kama vile minyororo ya maambukizi*)

#### TinyTex {.unnumbered}

TinyTex ni programu maalum ya usambazaji wa LaTeX, muhimu wakati wa kutengeneza faili za PDF kwenye R.\
Kwa taarifa zaidi tembelea <https://yihui.org/tinytex/>.

Kusanikisha TinyTex kutoka R:

```{r, eval=F}
install.packages('tinytex')
tinytex::install_tinytex()
# kuondoa TinyTeX, amrisha kupitia tinytex::uninstall_tinytex()
```

#### Pandoc {.unnumbered}

Pandoc ni kigeuzi cha faili, ni programu tofauti na R. **Inakuja ikiwa imeunganishwa na RStudio na haihitaji kupakuliwa.** Inasaidia mchakaot wa kubadililisha faili za Rmarkdown kwenda kwenye fomati ya .pdf na kuongeza ufanisi kwenye utendakazi mgumu.

#### RTools {.unnumbered}

RTools ni mkusanyiko wa programu kwa ajili ya kuunda vifurushi vya R.

Sanikisha kutoka tovuti: <https://cran.r-project.org/bin/windows/Rtools/>

#### phantomjs {.unnumbered}

Hii hutumiwa mara nyingi kupiga "picha za skrini" za kurasa za wavuti. Kwa mfano unapotengeneza msururu wa maambukizi (transmission chain) kwa kutumia kifurushi cha **epicontacts**, hutoa faili ya HTML ambayo ni shirikishi na kuweza kubadilika (interactive and dynamic). Ikiwa unataka picha tuli, inaweza kuwa muhimu kutumia kifurushi cha [**webshot**](https://wch.github.io/webshot/articles/intro.html) ili kuhariri mchakato huu kiotomatiki. Hii itahitaji programu ya nje iitwayo "phantomjs". Unaweza kusakinisha phantomjs kupitia kifurushi cha **webshot** kwa kuamrisha `webshot::install_phantomjs()`. the **webshot** package with the command `webshot::install_phantomjs()`.

<!-- ======================================================= -->

## RStudio {#rstudio}

### Maelekezo ya RStudio {.unnumbered}

**Kwanza, fungua RStudio.** Kwa vile aikoni zake zinaweza kufanana sana, hakikisha kuwa unafungua *RStudio* na si R.

Ili RStudio ifanye kazi lazima pia uwe umesakinisha R kwenye kompyuta (tazama hapo juu maelekezo ya usakinishaji).

**RStudio** ni kiolesura (Graphic user interface - GUI) kurahisisha matumizi ya **R**. Unaweza kuifikiria R kama injini ya gari, ifanyayo kazi muhimu, na RStudio kama mwili wa gari (pamoja na viti, vipengele vingine vya gari, n.k.) ambayo hukusaidia kutumia injini kusonga mbele! Unaweza kuona desa kamili la mtumiaji (PDF) kwa ajili ya kiolesura cha RStudio [hapa](https://www.rstudio.com/wp-content/uploads/2016/01/rstudio-IDE-cheatsheet.pdf)

Kawaida RStudio huonyesha paneli nne za mstatili.

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "RStudio_overview.png"))
```

[***KIDOKEZO:*** Ikiwa RStudio yako inaonyesha kidirisha kimoja tu cha kushoto ni kwa sababu bado huna hati zilizo wazi.]{style="color: black;"}

**Kidirisha cha 'Source' (Source Pane)**\
Kidirisha hiki, kwa asili huwa sehemu ya juu kushoto, ni nafasi ya kuhariri, kuendesha, na kuhifadhi [hati](#scripts) zako. Hati zina amri unazotaka kutekeleza. Kidirisha hiki kinaweza pia kuonyesha seti za data (fremu za data) ili kuzitazama.

Kwa watumiaji wa Stata, kidirisha hiki ni sawa na madirisha yako ya Do-file na Data Editor.

**Kidirisha cha 'R Console' (R Console Pane)**

R Console, kwa asili huwa ni kidirisha cha kushoto au cha chini-kushoto katika R Studio, ndiyo nyumba ya "injini" ya R. Hapa ndipo amri zinaendeshwa na matokeo yasiyo ya picha na ujumbe wa hitilafu/onyo huonekana. Unaweza kuingiza na kuendesha amri moja kwa moja kwenye 'R Console', lakini tambua kuwa amri hizi hazihifadhiwi kama zinavyofanya wakati wa kuendesha amri katika upande wa hati.

Ikiwa unaifahamu Stata, R Console ni kama 'Command Window' na pia 'Results Window'.

**Kidirisha cha 'Environment' (Environment Pane)**\
Kidirisha hiki, kwa asili huwa katika sehemu ya juu kulia, mara nyingi hutumika kuona muhtasari mfupi wa [Vifaakazi (Objects)](#objects) katika Mazingira ya R (R environment) katika kipindi cha sasa. Vifaakazi hivi huweza kujumuisha seti za data zilizoingizwa, zilizorekebishwa au kuundwa, vigezo ulivyofafanua (k.m. wiki maalum ya epi kwa uchanganuzi), au vekta au orodha ambazo umefafanua wakati wa uchanganuzi (k.m. majina ya maeneo). Unaweza kubofya mshale karibu na jina la fremu ya data ili kuona vigeuzo vyake.

Katika Stata, hii inafanana zaidi na dirisha la Kudhibiti cha Vigeuzo (Variables Manager window).

Kidirisha hiki pia kina *Historia (Historia)* ambapo unaweza kuona amri ambazo umeendesha hapo awali. Pia ina kichupo cha "Mafunzo (Tutorial)" ambapo unaweza kukamilisha mafunzo shirikishi ya R ikiwa umesakinisha kifurushi cha **learnr**. Pia ina kidirisha cha "Viunganisho (Connections)" cha viunganisho vya nje, na inaweza kuwa na kidirisha cha "Git" ukichagua kuunganishwa na Github.

**Kidirisha cha Michoro, Kitazamio, Vifurushi na Msaada (Plots, Viewer, Packages, and Help Pane)**\
Kidirisha cha chini kulia kinajumuisha vidirisha kadhaa muhimu. Grafikia ya kawaida ya michoro ikijumuisha ramani itaonyeshwa kwenye kidirisha cha 'Plot'. Matokeo shirikishi au HTML yataonyeshwa kwenye kidirisha cha 'Viewer'. Kidirisha cha 'Help' kinaweza kuonyesha hati na faili za msaada. Kidirisha cha 'File' ni kivinjari ambacho kinaweza kutumika kufungua au kufuta faili. Kidirisha cha Vifurushi hukuruhusu kuona, kusakinisha, kusasisha, kufuta, kupakia/kupakua vifurushi vya R, na kuona ni toleo gani la kifurushi ulicho nacho. Kwa maelezo zaidi kuhusu vifurushi tazama [sehemu ya vifurushi](#packages) hapa chini.

Kidirisha hiki ni sawa na madirisha ya 'Plots Manager' na 'Project Manager' kwenye Stata.

### RStudio settings {.unnumbered}

Badilisha mipangilio na mwonekano wa RStudio katika menyu kunjuzi ya *zana 'Tools'*, kwa kuchagua *Global Options*. Huko unaweza kubadilisha mipangilio ya asili, ikijumuisha mwonekano/rangi ya usuli.

```{r out.width = c('50%'), fig.show='hold', echo=F}
knitr::include_graphics(here::here("images", "RStudio_tools_options_1.png"))

knitr::include_graphics(here::here("images", "RStudio_tools_options.png"))
```

**Anzisha tena 'Restart'**

Endapo R yako itaganda, unaweza kuanzisha upya R kwa kwenda kwenye menyu ya Kipindi (Session menu) na kubofya 'Restart R' kuanzisha R upya. Hii inaepusha shida ya kufunga na kufungua RStudio. Kila kitu katika mazingira yako ya R (R Enviroment) kitaondolewa ukifanya hivi.

### Njia za mkato za kibodi {.unnumbered}

Baadhi ya njia muhimu sana za mkato za kibodi ziko hapa chini. Tazama mikato yote ya kibodi kwenye compyuta ya Windows, Max, na Linux katika ukurasa wa pili wa desa hili la [kiolesura cha mtumiaji wa RStudio (user interface cheatsheet)](https://www.rstudio.com/wp-content/uploads/2016/01/rstudio-IDE-cheatsheet.pdf).

+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Windows/Linux                    | Mac                    | Tukio                                                                                                                           |
+==================================+========================+=================================================================================================================================+
| Esc                              | Esc                    | Katisha amri ya sasa (inafaa ikiwa kwa bahati mbaya uliamrisha amri isiyokamilika na huwezi kuepuka kuona "+" kwenye koni ya R) |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Ctrl+s                           | Cmd+s                  | Hifadhi (hati)                                                                                                                  |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Tab                              | Tab                    | Kamilisha Kiotomatiki                                                                                                           |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Enter                     | Cmd + Enter            | Amrisha m(i)stari wa sasa/chaguo la kodi                                                                                        |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Shift + C                 | Cmd + Shift + c        | Toa maoni/toa maoni kwa mistari iliyoangaziwa                                                                                   |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Alt + -                          | Option + -             | Ingiza `<-`                                                                                                                     |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Shift + m                 | Cmd + Shift + m        | Ingiza `%>%`                                                                                                                    |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + l                         | Cmd + l                | Safisha koni ya R                                                                                                               |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + b                   | Cmd + Option + b       | Endesha kutoka mwanzo hadi mstari wa sasa                                                                                       |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + t                   | Cmd + Option + t       | Endesha mpaka sehemu ya sasa (R Markdown)                                                                                       |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + i                   | Cmd + Shift + r        | Pachika sehemu ya msimbo (into R Markdown)                                                                                      |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + c                   | Cmd + Option + c       | Endesha sehemu ya msimbo (R Markdown)                                                                                           |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| up/down arrows in R console      | Same                   | Pitia amri zilizoendeshwa hivi punde                                                                                            |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Shift + up/down arrows in script | Same                   | Chagua mstari zaidi ya mmoja wa msimbo                                                                                          |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + f                         | Cmd + f                | Tafuta na badilisha kwenye hati ya sasa                                                                                         |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Shift + f                 | Cmd + Shift + f        | Tafuta kwenye mafaili (Tafuta/badilisha kwenye hati nyingi)                                                                     |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Alt + l                          | Cmd + Option + l       | Kunja msimbo uliochaguliwa                                                                                                      |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+
| Shift + Alt + l                  | Cmd + Shift + Option+l | Kunjua msimbo uliochaguliwa                                                                                                     |
+----------------------------------+------------------------+---------------------------------------------------------------------------------------------------------------------------------+

[***KIDOKEZO:*** Tumia ufunguo wako 'Tab' unapoandika ili kupata vidokezo kamilifu vya kiotomatiki vya RStudio. Hii inaweza kuzuia makosa ya kiuandishi. Bonyeza Tab unapoandika ili kutoa menyu kunjuzi ya vitendakazi na vipengele vinavyowezekana, kulingana na ulichokwishandika.]{style="color: darkgreen;"}

<!-- ======================================================= -->

## Vitendakazi {#functions}

Vitendakazi ndio msingi wa kutumia R. Vitendakazi ndio nyenzo ya kufanya kazi na uendeshaji. Vitendakazi vingi huja vimeshasanikishwa kwenye R, vingi zaidi hupatikana kwa kupakuliwa katika *vifurushi* (zilizofafanuliwa katika sehemu ya [vifurushi](#packages), na unaweza hata kuandika vitendakazi vyako maalum!

Sehemu hii ya misingi ya vitendakazi inaelezea:

-   Vitendakazi ni nini na ni vipi vinafanya kazi\
-   Kitendakazi *arguments* ni nini\
-   Jinsi ya kupata msaada kuhusu kuelewa kitendakazi

*Kidokezo kuhusu maandishi (syntax) kwa ufupi:* Katika kitabu hiki, vitendakazi vimeandikwa kwa maandishi ikifuatiwa na mabano, kama hivi: `filter()`. Kama ilivyoelezwa kwenye sehemu ya [vifurushi](#packages), vitendakazi hupakuwaliwa ndani ya *vifurushi*. katika kitabu hiki, majina ya vifurushi yameandikwa kwa **msisitizo (bold)**, kama hivi **dplyr**. Mara nyingine kwenye maandishi ya mfano unaweza kuona majina ya vitendakazi yameunganishwa moja kwa moja kwenye jina la kifurushi ikifuatiwa na alama hizi (`::`) kama hivi: `dplyr::filter()`. Dhumuni la kuunganishwa hivi imeelezwa kwenye sehemu ya vifurushi.

<!-- ======================================================= -->

### Vitendakazi rahisi {.unnumbered}

**Vitendakazi ni sawa na mashine ambayo inapokea malighafi, kuchakata malighafi hizo, na kutoa jawabu.** Jinsi jawabu litakavyokuwa inategemeana na kitendakazi husika.

**Kiuhalisia vitendakazi hufanya kazi kwenye vitu vinavyowekwa ndani ya mabano yanayofuatia kitendakazi**. Kwa mfano, kitendakazi `sqrt()` huchakata kipeuo cha namba:

```{r basics_function_sqrt}
sqrt(49)
```

Vitu vinayoweza kuwekwa kwenye kitendakazi vinaweza pia kuwa orodha ya kwenda chini (orodhachini) ya limbiko la takwimu (dataset) (angalia sehemu ya [Vifaakazi](#objects) kupata taarifa zaidi kuhusu aina tofauti za vitu). Kwa kuwa R inaweza kutunza limbiko tofauti za takwimu, utahitaji kuainisha limbiko na orodhachini (variable). Njia mojawapo ya kufanya hivi ni kwa kutumia alama ya `$` kuunganisha jina la limbiko na orodhachini (`limbiko$orodhachini`). Mfano, kitendakazi `summary()` kinachakata orodhachini ya umri (`age`) kwenye limbiko la safu ya nambari (`linelist)`, na jawabu ni muhtasari wa idadi ya namba za orodhachini pamoja na nambari zisizokuwepo.

```{r basics_functions_summary}
# Chapisha muhtasari wa takwimu za orodhachini ya umri 'age' katika limbiko la safu ya nambari 'linelist'
summary(linelist$age)
```

[***TAMBUA:*** Nyuma ya pazia, kitendakazi kinawakilisha msimbo changamano wa ziada ambao mtumiaji amefungasha kuwa amri moja rahisi.]{style="color: black;"}

<!-- ======================================================= -->

### Vitendakazi vyenye hoja/amri nyingi {.unnumbered}

Mara nyingi vitendakazi huomba maingizo kadhaa, yanayoitwa ***hoja au arguments (English)***, huwa ndani ya mabano ya vitendakazi, huku vikitenganishwa na koma.

-   Unahitaji kukidhi hoja kadhaa ili kifaakazi kifanye kazi kwa usahihi, hoja zingine huwa za hiari\
-   Hoja za hiari huwa na chaguo za asili\
-   Hoja huweza kuwa ni mwingizo wa neno, tarakimu, kitendanishi cha mantiki (NDIO/HAPANA), na kadhalika

Hiki hapa ni kitendakazi cha kubuni kinachoitwa `oven_bake()`, kama mfano wa kawaida wa kifaa. Huchukua kifaakazi kama kiingizi (k.m. seti ya data, au katika mfano huu "unga") na kuifanyia shughuli kama inavyobainishwa na hoja za ziada (dakika, `minutes =` na jotoridi, `temperature =`). Toleo linaweza kuchapishwa kwenye dashibodi, au kuhifadhiwa kama kifaakazi kwa kutumia kitendaji `<-`.

```{r basics_functions_image, echo=F, out.width = "75%", fig.align = "center"}
knitr::include_graphics(here::here("images", "Function_Bread_Example.png"))
```

**Katika mfano halisi zaidi**, amri ya `age_pyramid()` hapa chini hutoa mpangilio wa piramidi ya umri kulingana na makundi vya umri vilivyobainishwa na safu wima iliyogawanyika kwa jozi, kama vile jinsia (`gender`). Kitendaji hupewa hupewa hoja tatu ndani ya mabano, zikitenganishwa na koma. Vitu vinavyowekwa kwenye kama hoja hutengeneza orodha mstari `linelist` kama fremu ya data kwa kutumia, `age_cat5` kama safu wima ili kuhesabu, na `gender` kama safuwima ya jozi kwa ajili ya kugawanya piramidi kwa rangi.

```{r basics_functions_arguments, include=FALSE, results='hide', message=FALSE, warning=FALSE,}
## tengeneza makundi ya umri kwa kubainisha vitenganishi vya ki-umri
linelist$age_group <- cut(linelist$age, breaks = c(0, 5, 10, 15, 20, 30, 45, 60))
```

```{r message=FALSE, warning=FALSE,  out.width = "75%", out.height="75%"}
# Tengeneza piramidi ya umri
age_pyramid(data = linelist, age_group = "age_cat5", split_by = "gender")
```

Amri iliyo hapo juu inaweza kuandikwa kwa usawa kama ilivyo hapo chini, kwa mtindo mrefu na kuweka kila hoja kwenye mstari wake. Mtindo huu unaweza kuwa rahisi kusoma, na rahisi kuandika "maoni" na `#` kuelezea kila sehemu (kutoa maoni kwa upana ni zoezi zuri!). Ili kutekeleza amri hii ndefu unaweza kuangazia amri nzima na ubofye "Run", au weka tu mshale wako kwenye mstari wa kwanza na kisha bofya Ctrl na Enter kwa wakati mmoja.

```{r message=FALSE, warning=FALSE,  out.width = "75%", out.height="75%"}
# Create an age pyramid
age_pyramid(
  data = linelist,        # tumia orodha mstari (use case linelist)
  age_group = "age_cat5", # tumia safuwima ya makundi ya umri (provide age group column)
  split_by = "gender"     # tumia safuwima ya jinsia kwa ajili ya pande mbili za piramidi (use gender column for two sides of pyramid)
  )
```

Nusu ya kwanza ya kuweka hoja (k.m. `data =`) haihitaji kubainishwa ikiwa hoja zimeandikwa kwa mpangilio maalum (uliobainishwa katika hati za vitendaji). Msimbo ulio hapa chini hutoa piramidi sawa kabisa na ilivyo hapo juu, kwa sababu kitendaji kinatarajia mpangilio wa hoja: fremu ya data, kigezo cha `age_group`, na kile cha `split_by`.

```{r, basics_functions_pyramid2, eval = FALSE, warning=FALSE, message=FALSE, , out.width = "75%", out.height="75%", eval=F}
# Amri hii itatengeneza mchoro sawa kabisa na hapo juu
age_pyramid(linelist, "age_cat5", "gender")
```

**Amri tata zaidi ya kutengeneza piramidi ya umri `age_pyramid()` inaweza kuhusisha hoja ya *optional* ili:**

-   Onyesha uwiano badala ya hesabu (weka `proportional = TRUE` kwenye lugha asili huwa ni `FALSE`)\
-   Bainisha rangi mbili ungependa kutumia (`pal =` ni kifupi cha neno "palette" na hutolewa na vekta ya majima mawili ya rangi. Angalia kwenye kurasa ya [vifaakazi](#objectstructure) jinsi ya kitendakazi `c()` hutengeneza vekta)

[***KUMBUKA:*** Kwa hoja unazobainisha kwa kutumia sehemu zote mbili za hoja (mfano, `proportional = TRUE`), mpangilio wake katika hoja zote haujalishi.]{style="color: black;"}

```{r message=FALSE, warning=FALSE, out.width = "75%", out.height="75%"}
age_pyramid(
  linelist,                    # tumia orodha mstari ya wagonjwa(use case linelist)
  "age_cat5",                  # safuwima ya makundi ya umri (age group column)
  "gender",                    # enganisha kwa jinsia (split by gender)
  proportional = TRUE,         # asilimia badala ya hesabu (percents instead of counts)
  pal = c("orange", "purple")  # rangi (colors)
  )
```

<!-- ======================================================= -->

### Uandishi wa Vitendakazi {.unnumbered}

R ni lugha inayoendeshwa kwa kutumia vitendaji, kwa hivyo unapaswa kujisikia kuwa na uwezo wa kuandika vitendaji vyako mwenyewe. Kuunda vitendakazi huleta faida kadhaa:

-   Ili kuwezesha programu za msimu - mgawanyo wa msimbo kwenda kwenye vipande huru na vinavyoweza kudhibitiwa\
-   Badilisha nakala-na-kubandika inayorudiwa, ambayo inaweza kuwa na makosa\
-   Toa majina yaliyo rahisi kukumbuka kwenye vipande vya msimbo

Jinsi ya kuandika chaguo la kukokotoa imefunikwa kwa kina katika ukurasa wa [Vitendaji vya Kuandika].

Jinsi ya kuandika vitendakazi imeelezwa kwa kina zaidi kwenye ukurasa wa [Kuandika vitendakazi](#writing_functions).

<!-- Kitendaji hupewa jina na kufafanuliwa kwa kutumia opereta `<-` kwa kitendaji maalum ndani ya **base** R inayoitwa `function()`. Ndani ya mabano, kunakuwa na ufafanuzi wa hoja ambazo kitendaji kitakubali. Hii inafuatwa na mabano yaliyojipinda `{ }`, ambamo msimbo halisi wa kitendaji huandikwa.     -->


```{r, eval=F, echo=F}
my_function <- function( ARGUMENTS HERE ){ CODE HERE }
```

<!-- The arguments should be provided in the syntax `argument = default`, separated by commas.   -->

<!-- Here is an example where we create a function `staff_calc()` to serve as a staffing calculator for COVID-19 case investigation and contact tracing calls.   -->

<!-- The arguments (inputs) and their default values will be:   -->

<!-- * `daily_cases = NULL` The number of new COVID-19 cases per day   -->

<!-- * `contacts_each = 5` The number contacts enumerated for each case   -->

<!-- * `time_case = 0.5`  Number of hours to complete a case investigaton by phone   -->

<!-- * `time_contact = 0.25`  Number of hours to complete a contact follow-up by phone   -->

<!-- * `time_day = 8` The number of hours one staff works per day   -->

<!-- Below, the function is created. The code ends with the special function `return()`, which is what the function produces.    -->

<!-- ```{r message=FALSE, warning=FALSE, out.width = "75%", out.height="75%"} -->

<!-- staff_calc <- function(daily_cases = NULL, contacts_each = 5, -->

<!--                        time_case = 0.5, time_contact = 0.25, time_day = 8){ -->

<!--   # Define total daily hours for calling cases -->

<!--   case_hours <- daily_cases * time_case  -->

<!--   # Define total daily hours for calling contacts -->

<!--   contact_hours <- daily_cases * contacts_each * time_contact -->

<!--   # Calculate number of staff required -->

<!--   staff_required <- (case_hours + contact_hours)/time_day -->

<!--   return(staff_required) -->

<!-- } -->

<!-- ``` -->

<!-- Once this code is run, the function will be defined and will appear in the R Environment. We can run the function. Below all the default values are used and the `daily_cases = ` is set to 150.   -->

```{r eval=F, echo=F, message=FALSE, warning=FALSE, out.width = "75%", out.height="75%"}
staff_calc(daily_cases = 150)
```

```{r, eval=F, echo=F}
case_incidence <- tibble(
  dates = seq.Date(from = as.Date("2020-05-01"), to = as.Date("2020-05-21"), by = 1),
  projected_incidence = c(102,110,50,37,106,190,146,138,135,111,60,43,189,184,185,80,44,97,254,291,288),
  staff_needed = staff_calc(projected_incidence)
)

ggplot(case_incidence, aes(x = dates))+
  geom_line(aes(y = projected_incidence))+
  geom_line(aes(y = staff_needed))
```

<!-- There are many other nuances to understand when writing functions, as discussed in the page [Writing functions].   -->

<!-- ======================================================= -->

<!-- ======================================================= -->

## Vifurushi {#packages}

**Packages contain functions.**

An R package is a shareable bundle of code and documentation that contains pre-defined functions. Users in the R community develop packages all the time catered to specific problems, it is likely that one can help with your work! You will install and use hundreds of packages in your use of R.

On installation, R contains **"base"** packages and functions that perform common elementary tasks. But many R users create specialized functions, which are verified by the R community and which you can download as a **package** for your own use. In this handbook, package names are written in **bold**. One of the more challenging aspects of R is that there are often many functions or packages to choose from to complete a given task.

### Install and load {.unnumbered}

*Functions* are contained within **packages** which can be downloaded ("installed") to your computer from the internet. Once a package is downloaded, it is stored in your "library". You can then access the functions it contains during your current R session by "loading" the package.

*Think of R as your personal library*: When you download a package, your library gains a new book of functions, but each time you want to use a function in that book, you must borrow ("load") that book from your library.

In summary: to use the functions available in an R package, 2 steps must be implemented:

1)  The package must be **installed** (once), *and*\
2)  The package must be **loaded** (each R session)

#### Your library {.unnumbered}

Your "library" is actually a folder on your computer, containing a folder for each package that has been installed. Find out where R is installed in your computer, and look for a folder called "win-library". For example: `R\win-library\4.0` (the 4.0 is the R version - you'll have a different library for each R version you've downloaded).

You can print the file path to your library by entering `.libPaths()` (empty parentheses). This becomes especially important if working with [R on network drives].

#### Install from CRAN {.unnumbered}

Most often, R users download packages from CRAN. CRAN (Comprehensive R Archive Network) is an online public warehouse of R packages that have been published by R community members.

Are you worried about viruses and security when downloading a package from CRAN? Read [this article](https://support.rstudio.com/hc/en-us/articles/360042593974-R-and-R-Package-Security) on the topic.

#### How to install and load {.unnumbered}

In this handbook, we suggest using the **pacman** package (short for "package manager"). It offers a convenient function `p_load()` which will install a package if necessary *and* load it for use in the current R session.

The syntax quite simple. Just list the names of the packages within the `p_load()` parentheses, separated by commas. This command will install the **rio**, **tidyverse**, and **here** packages if they are not yet installed, and will load them for use. This makes the `p_load()` approach convenient and concise if sharing scripts with others. Note that package names are case-sensitive.

```{r}
# Install (if necessary) and load packages for use
pacman::p_load(rio, tidyverse, here)
```

Note that we have used the syntax `pacman::p_load()` which explicitly writes the package name (**pacman**) prior to the function name (`p_load()`), connected by two colons `::`. This syntax is useful because it also loads the **pacman** package (assuming it is already installed).

There are alternative **base** R functions that you will see often. The **base** R function for installing a package is `install.packages()`. The name of the package to install must be provided in the parentheses *in quotes*. If you want to install multiple packages in one command, they must be listed within a character vector `c()`.

Note: this command *installs* a package, but does *not* load it for use in the current session.

```{r, eval=F}
# install a single package with base R
install.packages("tidyverse")

# install multiple packages with base R
install.packages(c("tidyverse", "rio", "here"))
```

Installation can also be accomplished point-and-click by going to the RStudio "Packages" pane and clicking "Install" and searching for the desired package name.

The **base** R function to **load** a package for use (after it has been installed) is `library()`. It can load only one package at a time (another reason to use `p_load()`). You can provide the package name with or without quotes.

```{r, eval=F}
# load packages for use, with base R
library(tidyverse)
library(rio)
library(here)
```

To check whether a package in installed and/or loaded, you can view the Packages pane in RStudio. If the package is installed, it is shown there with version number. If its box is checked, it is loaded for the current session.

**Install from Github**

Sometimes, you need to install a package that is not yet available from CRAN. Or perhaps the package is available on CRAN but you want the *development version* with new features not yet offered in the more stable published CRAN version. These are often hosted on the website [github.com](https://github.com/) in a free, public-facing code "repository". Read more about Github in the handbook page on [Version control and collaboration with Git and Github].

To download R packages from Github, you can use the function `p_load_gh()` from **pacman**, which will install the package if necessary, and load it for use in your current R session. Alternatives to install include using the **remotes** or **devtools** packages. Read more about all the **pacman** functions in the [package documentation](https://cran.r-project.org/web/packages/pacman/pacman.pdf).

To install from Github, you have to provide more information. You must provide:

1)  The Github ID of the repository owner
2)  The name of the repository that contains the package\
3)  *(optional) The name of the "branch" (specific development version) you want to download*

In the examples below, the first word in the quotation marks is the Github ID of the repository owner, after the slash is the name of the repository (the name of the package).

```{r, eval=F}
# install/load the epicontacts package from its Github repository
p_load_gh("reconhub/epicontacts")
```

If you want to install from a "branch" (version) other than the main branch, add the branch name after an "\@", after the repository name.

```{r, eval=F}
# install the "timeline" branch of the epicontacts package from Github
p_load_gh("reconhub/epicontacts@timeline")
```

If there is no difference between the Github version and the version on your computer, no action will be taken. You can "force" a re-install by instead using `p_load_current_gh()` with the argument `update = TRUE`. Read more about **pacman** in this [online vignette](http://trinker.github.io/pacman/vignettes/Introduction_to_pacman.html)

**Install from ZIP or TAR**

You could install the package from a URL:

```{r, eval=F}
packageurl <- "https://cran.r-project.org/src/contrib/Archive/dsr/dsr_0.2.2.tar.gz"
install.packages(packageurl, repos=NULL, type="source")
```

Or, download it to your computer in a zipped file:

Option 1: using `install_local()` from the **remotes** package

```{r, eval=F}
remotes::install_local("~/Downloads/dplyr-master.zip")
```

Option 2: using `install.packages()` from **base** R, providing the file path to the ZIP file and setting `type = "source` and `repos = NULL`.

```{r, eval=F}
install.packages("~/Downloads/dplyr-master.zip", repos=NULL, type="source")
```

### Code syntax {.unnumbered}

For clarity in this handbook, functions are sometimes preceded by the name of their package using the `::` symbol in the following way: `package_name::function_name()`

Once a package is loaded for a session, this explicit style is not necessary. One can just use `function_name()`. However writing the package name is useful when a function name is common and may exist in multiple packages (e.g. `plot()`). Writing the package name will also load the package if it is not already loaded.

```{r eval=FALSE}
# This command uses the package "rio" and its function "import()" to import a dataset
linelist <- rio::import("linelist.xlsx", which = "Sheet1")
```

### Function help {.unnumbered}

To read more about a function, you can search for it in the Help tab of the lower-right RStudio. You can also run a command like `?thefunctionname` (put the name of the function after a question mark) and the Help page will appear in the Help pane. Finally, try searching online for resources.

### Update packages {.unnumbered}

You can update packages by re-installing them. You can also click the green "Update" button in your RStudio Packages pane to see which packages have new versions to install. Be aware that your old code may need to be updated if there is a major revision to how a function works!

### Delete packages {.unnumbered}

Use `p_delete()` from **pacman**, or `remove.packages()` from **base** R. Alternatively, go find the folder which contains your library and manually delete the folder.

### Dependencies {.unnumbered}

Packages often depend on other packages to work. These are called dependencies. If a dependency fails to install, then the package depending on it may also fail to install.

See the dependencies of a package with `p_depends()`, and see which packages depend on it with `p_depends_reverse()`

### Masked functions {.unnumbered}

It is not uncommon that two or more packages contain the same function name. For example, the package **dplyr** has a `filter()` function, but so does the package **stats**. The default `filter()` function depends on the order these packages are first loaded in the R session - the later one will be the default for the command `filter()`.

You can check the order in your Environment pane of R Studio - click the drop-down for "Global Environment" and see the order of the packages. Functions from packages *lower* on that drop-down list will mask functions of the same name in packages that appear higher in the drop-down list. When first loading a package, R will warn you in the console if masking is occurring, but this can be easy to miss.

```{r out.width = "50%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "masking_functions.png"))
```

Here are ways you can fix masking:

1)  Specify the package name in the command. For example, use `dplyr::filter()`\
2)  Re-arrange the order in which the packages are loaded (e.g. within `p_load()`), and **start a new R session**

### Detach / unload {.unnumbered}

To detach (unload) a package, use this command, with the correct package name and only one colon. Note that this may not resolve masking.

```{r, eval=F}
detach(package:PACKAGE_NAME_HERE, unload=TRUE)
```

### Install older version {.unnumbered}

See this [guide](https://support.rstudio.com/hc/en-us/articles/219949047-Installing-older-versions-of-packages) to install an older version of a particular package.

### Suggested packages {.unnumbered}

See the page on [Suggested packages] for a listing of packages we recommend for everyday epidemiology.

<!-- ======================================================= -->

## Hati {#scripts}

Scripts are a fundamental part of programming. They are documents that hold your commands (e.g. functions to create and modify datasets, print visualizations, etc). You can save a script and run it again later. There are many advantages to storing and running your commands from a script (vs. typing commands one-by-one into the R console "command line"):

-   Portability - you can share your work with others by sending them your scripts\
-   Reproducibility - so that you and others know exactly what you did\
-   Version control - so you can track changes made by yourself or colleagues\
-   Commenting/annotation - to explain to your colleagues what you have done

### Commenting {.unnumbered}

In a script you can also annotate ("comment") around your R code. Commenting is helpful to explain to yourself and other readers what you are doing. You can add a comment by typing the hash symbol (\#) and writing your comment after it. The commented text will appear in a different color than the R code.

Any code written after the \# will not be run. Therefore, placing a \# before code is also a useful way to temporarily block a line of code ("comment out") if you do not want to delete it). You can comment out/in multiple lines at once by highlighting them and pressing Ctrl+Shift+c (Cmd+Shift+c in Mac).

```{r, eval = F}
# A comment can be on a line by itself
# import data
linelist <- import("linelist_raw.xlsx") %>%   # a comment can also come after code
# filter(age > 50)                          # It can also be used to deactivate / remove a line of code
  count()

```

-   Comment on *what* you are doing *and on **why** you are doing it*.\
-   Break your code into logical sections\
-   Accompany your code with a text step-by-step description of what you are doing (e.g. numbered steps)

### Style {.unnumbered}

It is important to be conscious of your coding style - especially if working on a team. We advocate for the **tidyverse** [style guide](https://style.tidyverse.org/). There are also packages such as **styler** and **lintr** which help you conform to this style.

A few very basic points to make your code readable to others:\
\* When naming objects, use only lowercase letters, numbers, and underscores `_`, e.g. `my_data`\
\* Use frequent spaces, including around operators, e.g. `n = 1` and `age_new <- age_old + 3`

### Example Script {.unnumbered}

Below is an example of a short R script. Remember, the better you succinctly explain your code in comments, the more your colleagues will like you!

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "example_script.png"))
```

<!-- ======================================================= -->

### R markdown {.unnumbered}

An R markdown script is a type of R script in which the script itself *becomes* an output document (PDF, Word, HTML, Powerpoint, etc.). These are incredibly useful and versatile tools often used to create dynamic and automated reports. Even this website and handbook is produced with R markdown scripts!

It is worth noting that beginner R users can also use R Markdown - do not be intimidated! To learn more, see the handbook page on [Reports with R Markdown] documents.

<!-- ======================================================= -->

### R notebooks {.unnumbered}

There is no difference between writing in a Rmarkdown vs an R notebook. However the execution of the document differs slightly. See this [site](http://uc-r.github.io/r_notebook) for more details.

<!-- ======================================================= -->

### Shiny {.unnumbered}

Shiny apps/websites are contained within one script, which must be named `app.R`. This file has three components:

1)  A user interface (ui)\
2)  A server function\
3)  A call to the `shinyApp` function

See the handbook page on [Dashboards with Shiny], or this online tutorial: [Shiny tutorial](https://shiny.rstudio.com/tutorial/written-tutorial/lesson1/)

*In older times, the above file was split into two files (`ui.R` and `server.R`)*

### Code folding {.unnumbered}

You can collapse portions of code to make your script easier to read.

To do this, create a text header with \#, write your header, and follow it with at least 4 of either dashes (-), hashes (\#) or equals (=). When you have done this, a small arrow will appear in the "gutter" to the left (by the row number). You can click this arrow and the code below until the next header will collapse and a dual-arrow icon will appear in its place.

To expand the code, either click the arrow in the gutter again, or the dual-arrow icon. There are also keyboard shortcuts as explained in the [RStudio section](#rstudio) of this page.

By creating headers with \#, you will also activate the Table of Contents at the bottom of your script (see below) that you can use to navigate your script. You can create sub-headers by adding more \# symbols, for example \# for primary, \#\# for seconary, and \#\#\# for tertiary headers.

Below are two versions of an example script. On the left is the original with commented headers. On the right, four dashes have been written after each header, making them collapsible. Two of them have been collapsed, and you can see that the Table of Contents at the bottom now shows each section.

```{r, out.width = c('50%'), fig.show='hold', echo=F}
knitr::include_graphics(here::here("images", "code_folding1.png"))
knitr::include_graphics(here::here("images", "code_folding2.png"))
```

Other areas of code that are automatically eligible for folding include "braced" regions with brackets `{ }` such as function definitions or conditional blocks (if else statements). You can read more about code folding at the RStudio [site](https://support.rstudio.com/hc/en-us/articles/200484568-Code-Folding-and-Sections).

<!-- ======================================================= -->

<!-- ======================================================= -->

<!-- ======================================================= -->

## Working directory

The working directory is the root folder location used by R for your work - where R looks for and saves files by default. By default, it will save new files and outputs to this location, and will look for files to import (e.g. datasets) here as well.

The working directory appears in grey text at the top of the RStudio Console pane. You can also print the current working directory by running `getwd()` (leave the parentheses empty).

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "working_directory_1.png"))
```

### Recommended approach {.unnumbered}

**See the page on [R projects] for details on our recommended approach to managing your working directory.**\
A common, efficient, and trouble-free way to manage your working directory and file paths is to combine these 3 elements in an [R project][R projects]-oriented workflow:

1)  An R Project to store all your files (see page on [R projects])\
2)  The **here** package to locate files (see page on [Import and export])\
3)  The **rio** package to import/export files (see page on [Import and export])

<!-- ======================================================= -->

### Set by command {.unnumbered}

Until recently, many people learning R were taught to begin their scripts with a `setwd()` command. Please instead consider using an [R project][R projects]-oriented workflow and read the [reasons for not using `setwd()`](https://www.tidyverse.org/blog/2017/12/workflow-vs-script/). In brief, your work becomes specific to your computer, file paths used to import and export files become "brittle", and this severely hinders collaboration and use of your code on any other computer. There are easy alternatives!

As noted above, although we do not recommend this approach in most circumstances, you can use the command `setwd()` with the desired folder file path in quotations, for example:

```{r, eval=F}
setwd("C:/Documents/R Files/My analysis")
```

[***DANGER:*** Setting a working directory with `setwd()` *can* be "brittle" if the file path is specific to one computer. Instead, use file paths relative to an R Project root directory (with the **here** package).]{style="color: red;"}

<!-- ======================================================= -->

### Set manually {.unnumbered}

To set the working directory manually (the point-and-click equivalent of `setwd()`), click the Session drop-down menu and go to "Set Working Directory" and then "Choose Directory". This will set the working directory for that specific R session. Note: if using this approach, you will have to do this manually each time you open RStudio.

<!-- ======================================================= -->

### Within an R project {.unnumbered}

If using an R project, the working directory will default to the R project root folder that contains the ".rproj" file. This will apply if you open RStudio by clicking open the R Project (the file with ".rproj" extension).

<!-- ======================================================= -->

### Working directory in an R markdown {.unnumbered}

In an R markdown script, the default working directory is the folder the Rmarkdown file (`.Rmd`) is saved within. If using an R project and **here** package, this does not apply and the working directory will be `here()` as explained in the [R projects] page.

If you want to change the working directory of a stand-alone R markdown (not in an R project), if you use `setwd()` this will only apply to that specific code chunk. To make the change for all code chunks in an R markdown, edit the setup chunk to add the `root.dir =` parameter, such as below:

```{r, eval=F}
knitr::opts_knit$set(root.dir = 'desired/directorypath')
```

It is much easier to just use the R markdown within an R project and use the **here** package.

<!-- ======================================================= -->

### Providing file paths {.unnumbered}

Perhaps the most common source of frustration for an R beginner (at least on a Windows machine) is typing in a file path to import or export data. There is a thorough explanation of how to best input file paths in the [Import and export] page, but here are a few key points:

**Broken paths**

Below is an example of an "absolute" or "full address" file path. These will likely break if used by another computer. One exception is if you are using a shared/network drive.

    C:/Users/Name/Document/Analytic Software/R/Projects/Analysis2019/data/March2019.csv  

**Slash direction**

*If typing in a file path, be aware the direction of the slashes.* Use *forward slashes* (`/`) to separate the components ("data/provincial.csv"). For Windows users, the default way that file paths are displayed is with *back slashes* (\\) - so you will need to change the direction of each slash. If you use the **here** package as described in the [R projects] page the slash direction is not an issue.

**Relative file paths**

We generally recommend providing "relative" filepaths instead - that is, the path *relative to* the root of your R Project. You can do this using the **here** package as explained in the [R projects] page. A relativel filepath might look like this:

```{r, eval=F}
# Import csv linelist from the data/linelist/clean/ sub-folders of an R project
linelist <- import(here("data", "clean", "linelists", "marin_country.csv"))
```

Even if using relative file paths within an R project, you can still use absolute paths to import/export data outside your R project.

<!-- ======================================================= -->

## Vifaakazi {#objects}

Everything in R is an object, and R is an "object-oriented" language. These sections will explain:

-   How to create objects (`<-`)
-   Types of objects (e.g. data frames, vectors..)\
-   How to access subparts of objects (e.g. variables in a dataset)\
-   Classes of objects (e.g. numeric, logical, integer, double, character, factor)

<!-- ======================================================= -->

### Everything is an object {.unnumbered}

*This section is adapted from the [R4Epis project](https://r4epis.netlify.app/training/r_basics/objects/).*\
Everything you store in R - datasets, variables, a list of village names, a total population number, even outputs such as graphs - are **objects** which are **assigned a name** and **can be referenced** in later commands.

An object exists when you have assigned it a value (see the assignment section below). When it is assigned a value, the object appears in the Environment (see the upper right pane of RStudio). It can then be operated upon, manipulated, changed, and re-defined.

<!-- ======================================================= -->

### Defining objects (`<-`) {.unnumbered}

**Create objects *by assigning them a value* with the \<- operator.**\
You can think of the assignment operator `<-` as the words "is defined as". Assignment commands generally follow a standard order:

**object_name** \<- **value** (or process/calculation that produce a value)

For example, you may want to record the current epidemiological reporting week as an object for reference in later code. In this example, the object `current_week` is created when it is assigned the value `"2018-W10"` (the quote marks make this a character value). The object `current_week` will then appear in the RStudio Environment pane (upper-right) and can be referenced in later commands.

See the R commands and their output in the boxes below.

```{r basics_objects_assignment}
current_week <- "2018-W10"   # this command creates the object current_week by assigning it a value
current_week                 # this command prints the current value of current_week object in the console
```

[***NOTE:*** Note the `[1]` in the R console output is simply indicating that you are viewing the first item of the output]{style="color: black;"}

[***CAUTION:*** **An object's value can be over-written** at any time by running an assignment command to re-define its value. Thus, the **order of the commands run is very important**.]{style="color: orange;"}

The following command will re-define the value of `current_week`:

```{r basics_objects_reassignment}
current_week <- "2018-W51"   # assigns a NEW value to the object current_week
current_week                 # prints the current value of current_week in the console
```

**Equals signs `=`**

You will also see equals signs in R code:

-   A double equals sign `==` between two objects or values asks a logical *question*: "is this equal to that?".\
-   You will also see equals signs within functions used to specify values of function arguments (read about these in sections below), for example `max(age, na.rm = TRUE)`.\
-   You *can* use a single equals sign `=` in place of `<-` to create and define objects, but this is discouraged. You can read about why this is discouraged [here](https://renkun.me/2014/01/28/difference-between-assignment-operators-in-r/).

**Datasets**

Datasets are also objects (typically "dataframes") and must be assigned names when they are imported. In the code below, the object `linelist` is created and assigned the value of a CSV file imported with the **rio** package and its `import()` function.

```{r basics_objects_dataframes, eval=FALSE}
# linelist is created and assigned the value of the imported CSV file
linelist <- import("my_linelist.csv")
```

You can read more about importing and exporting datasets with the section on [Import and export].

[***CAUTION:*** A quick note on naming of objects:]{style="color: orange;"}

-   Object names must not contain spaces, but you should use underscore (\_) or a period (.) instead of a space.\
-   Object names are case-sensitive (meaning that Dataset_A is different from dataset_A).
-   Object names must begin with a letter (cannot begin with a number like 1, 2 or 3).

**Outputs**

Outputs like tables and plots provide an example of how outputs can be saved as objects, or just be printed without being saved. A cross-tabulation of gender and outcome using the **base** R function `table()` can be printed directly to the R console (*without* being saved).

```{r}
# printed to R console only
table(linelist$gender, linelist$outcome)
```

But the same table can be saved as a named object. Then, optionally, it can be printed.

```{r}
# save
gen_out_table <- table(linelist$gender, linelist$outcome)

# print
gen_out_table
```

**Columns**

Columns in a dataset are also objects and can be defined, over-written, and created as described below in the section on Columns.

You can use the assignment operator from **base** R to create a new column. Below, the new column `bmi` (Body Mass Index) is created, and for each row the new value is result of a mathematical operation on the row's value in the `wt_kg` and `ht_cm` columns.

```{r, eval=F}
# create new "bmi" column using base R syntax
linelist$bmi <- linelist$wt_kg / (linelist$ht_cm/100)^2
```

However, in this handbook, we emphasize a different approach to defining columns, which uses the function `mutate()` from the **dplyr** package and *piping* with the pipe operator (`%>%`). The syntax is easier to read and there are other advantages explained in the page on [Cleaning data and core functions]. You can read more about *piping* in the Piping section below.

```{r, eval=F}
# create new "bmi" column using dplyr syntax
linelist <- linelist %>% 
  mutate(bmi = wt_kg / (ht_cm/100)^2)
```

<!-- ======================================================= -->

### Object structure {.unnumbered}

**Objects can be a single piece of data (e.g. `my_number <- 24`), or they can consist of structured data.**

The graphic below is borrowed from [this online R tutorial](http://venus.ifca.unican.es/Rintro/dataStruct.html). It shows some common data structures and their names. Not included in this image is spatial data, which is discussed in the [GIS basics] page.

```{r basics_objects_structures, echo=F, out.width = "75%", out.height="50%", fig.align = "center"}
knitr::include_graphics(here::here("images", "R_data_structures.png"))
```

In epidemiology (and particularly field epidemiology), you will *most commonly* encounter data frames and vectors:

+------------------+--------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------+
| Common structure | Explanation                                                                                      | Example                                                                             |
+==================+==================================================================================================+=====================================================================================+
| Vectors          | A container for a sequence of singular objects, all of the same class (e.g. numeric, character). | **"Variables" (columns) in data frames are vectors** (e.g. the column `age_years`). |
+------------------+--------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------+
| Data Frames      | Vectors (e.g. columns) that are bound together that all have the same number of rows.            | `linelist` is a data frame.                                                         |
+------------------+--------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------+

Note that to create a vector that "stands alone" (is not part of a data frame) the function `c()` is used to combine the different elements. For example, if creating a vector of colors plot's color scale: `vector_of_colors <- c("blue", "red2", "orange", "grey")`

<!-- ======================================================= -->

### Object classes {.unnumbered}

All the objects stored in R have a *class* which tells R how to handle the object. There are many possible classes, but common ones include:

+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Class      | Explanation                                                                                                                                                                             | Examples                                                                                              |
+============+=========================================================================================================================================================================================+=======================================================================================================+
| Character  | These are text/words/sentences **"within quotation marks"**. Math cannot be done on these objects.                                                                                      | "Character objects are in quotation marks"                                                            |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Integer    | Numbers that are **whole only** (no decimals)                                                                                                                                           | -5, 14, or 2000                                                                                       |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Numeric    | These are numbers and **can include decimals**. If within quotation marks they will be considered character class.                                                                      | 23.1 or 14                                                                                            |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Factor     | These are vectors that have a **specified order** or hierarchy of values                                                                                                                | An variable of economic status with ordered values                                                    |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Date       | **Once R is told that certain data are Dates**, these data can be manipulated and displayed in special ways. See the page on [Working with dates] for more information.                 | 2018-04-12 or 15/3/1954 or Wed 4 Jan 1980                                                             |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Logical    | Values must be one of the two special values TRUE or FALSE (note these are **not** "TRUE" and "FALSE" in quotation marks)                                                               | TRUE or FALSE                                                                                         |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| data.frame | A data frame is how R stores a **typical dataset**. It consists of vectors (columns) of data bound together, that all have the same number of observations (rows).                      | The example AJS dataset named `linelist_raw` contains 68 variables with 300 observations (rows) each. |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| tibble     | tibbles are a variation on data frame, the main operational difference being that they print more nicely to the console (display first 10 rows and only columns that fit on the screen) | Any data frame, list, or matrix can be converted to a tibble with `as_tibble()`                       |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| list       | A list is like vector, but holds other objects that can be other different classes                                                                                                      | A list could hold a single number, and a dataframe, and a vector, and even another list within it!    |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+

**You can test the class of an object by providing its name to the function `class()`**. Note: you can reference a specific column within a dataset using the `$` notation to separate the name of the dataset and the name of the column.

```{r, echo=TRUE,}
class(linelist)         # class should be a data frame or tibble

class(linelist$age)     # class should be numeric

class(linelist$gender)  # class should be character
```

Sometimes, a column will be converted to a different class automatically by R. Watch out for this! For example, if you have a vector or column of numbers, but a character value is inserted... the entire column will change to class character.

```{r}
num_vector <- c(1,2,3,4,5) # define vector as all numbers
class(num_vector)          # vector is numeric class
num_vector[3] <- "three"   # convert the third element to a character
class(num_vector)          # vector is now character class
```

One common example of this is when manipulating a data frame in order to print a table - if you make a total row and try to paste/glue together percents in the same cell as numbers (e.g. `23 (40%)`), the entire numeric column above will convert to character and can no longer be used for mathematical calculations.**Sometimes, you will need to convert objects or columns to another class.**

+------------------+---------------------------------------------------------------------------------------+
| Function         | Action                                                                                |
+==================+=======================================================================================+
| `as.character()` | Converts to character class                                                           |
+------------------+---------------------------------------------------------------------------------------+
| `as.numeric()`   | Converts to numeric class                                                             |
+------------------+---------------------------------------------------------------------------------------+
| `as.integer()`   | Converts to integer class                                                             |
+------------------+---------------------------------------------------------------------------------------+
| `as.Date()`      | Converts to Date class - Note: see section on [dates](#dates) for details             |
+------------------+---------------------------------------------------------------------------------------+
| `factor()`       | Converts to factor - Note: re-defining order of value levels requires extra arguments |
+------------------+---------------------------------------------------------------------------------------+

Likewise, there are **base** R functions to check whether an object IS of a specific class, such as `is.numeric()`, `is.character()`, `is.double()`, `is.factor()`, `is.integer()`

Here is [more online material on classes and data structures in R](https://swcarpentry.github.io/r-novice-inflammation/13-supp-data-structures/).

<!-- ======================================================= -->

### Columns/Variables (`$`) {.unnumbered}

**A column in a data frame is technically a "vector" (see table above)** - a series of values that must all be the same class (either character, numeric, logical, etc).

A vector can exist independent of a data frame, for example a vector of column names that you want to include as explanatory variables in a model. To create a "stand alone" vector, use the `c()` function as below:

```{r, warning=F, message=F}
# define the stand-alone vector of character values
explanatory_vars <- c("gender", "fever", "chills", "cough", "aches", "vomit")

# print the values in this named vector
explanatory_vars
```

**Columns in a data frame are also vectors and can be called, referenced, extracted, or created using the `$` symbol.** The `$` symbol connects the name of the column to the name of its data frame. In this handbook, we try to use the word "column" instead of "variable".

```{r basics_objects_call, eval=F}
# Retrieve the length of the vector age_years
length(linelist$age) # (age is a column in the linelist data frame)

```

By typing the name of the dataframe followed by `$` you will also see a drop-down menu of all columns in the data frame. You can scroll through them using your arrow key, select one with your Enter key, and avoid spelling mistakes!

```{r echo=F, out.width = "100%", fig.align = "center"}
knitr::include_graphics(here::here("images", "Calling_Names.gif"))
```

[***ADVANCED TIP:*** Some more complex objects (e.g. a list, or an `epicontacts` object) may have multiple levels which can be accessed through multiple dollar signs. For example `epicontacts$linelist$date_onset`]{style="color: darkgreen;"}

<!-- ======================================================= -->

### Access/index with brackets (`[ ]`) {.unnumbered}

You may need to view parts of objects, also called "indexing", which is often done using the square brackets `[ ]`. Using `$` on a dataframe to access a column is also a type of indexing.

```{r}
my_vector <- c("a", "b", "c", "d", "e", "f")  # define the vector
my_vector[5]                                  # print the 5th element
```

Square brackets also work to return specific parts of an returned output, such as the output of a `summary()` function:

```{r}
# All of the summary
summary(linelist$age)

# Just the second element of the summary, with name (using only single brackets)
summary(linelist$age)[2]

# Just the second element, without name (using double brackets)
summary(linelist$age)[[2]]

# Extract an element by name, without showing the name
summary(linelist$age)[["Median"]]

```

Brackets also work on data frames to view specific rows and columns. You can do this using the syntax `dataframe[rows, columns]`:

```{r basics_objects_access, eval=F}
# View a specific row (2) from dataset, with all columns (don't forget the comma!)
linelist[2,]

# View all rows, but just one column
linelist[, "date_onset"]

# View values from row 2 and columns 5 through 10
linelist[2, 5:10] 

# View values from row 2 and columns 5 through 10 and 18
linelist[2, c(5:10, 18)] 

# View rows 2 through 20, and specific columns
linelist[2:20, c("date_onset", "outcome", "age")]

# View rows and columns based on criteria
# *** Note the dataframe must still be named in the criteria!
linelist[linelist$age > 25 , c("date_onset", "outcome", "age")]

# Use View() to see the outputs in the RStudio Viewer pane (easier to read) 
# *** Note the capital "V" in View() function
View(linelist[2:20, "date_onset"])

# Save as a new object
new_table <- linelist[2:20, c("date_onset")] 
```

Note that you can also achieve the above row/column indexing on data frames and tibbles using **dplyr** syntax (functions `filter()` for rows, and `select()` for columns). Read more about these core functions in the [Cleaning data and core functions] page.

To filter based on "row number", you can use the **dplyr** function `row_number()` with open parentheses as part of a logical filtering statement. Often you will use the `%in%` operator and a range of numbers as part of that logical statement, as shown below. To see the *first* N rows, you can also use the special **dplyr** function `head()`.

```{r, eval=F}
# View first 100 rows
linelist %>% head(100)

# Show row 5 only
linelist %>% filter(row_number() == 5)

# View rows 2 through 20, and three specific columns (note no quotes necessary on column names)
linelist %>% filter(row_number() %in% 2:20) %>% select(date_onset, outcome, age)
```

When indexing an object of class **list**, single brackets always return with class list, even if only a single object is returned. Double brackets, however, can be used to access a single element and return a different class than list.\
Brackets can also be written after one another, as demonstrated below.

This [visual explanation of lists indexing, with pepper shakers](https://r4ds.had.co.nz/vectors.html#lists-of-condiments) is humorous and helpful.

```{r}
# define demo list
my_list <- list(
  # First element in the list is a character vector
  hospitals = c("Central", "Empire", "Santa Anna"),
  
  # second element in the list is a data frame of addresses
  addresses   = data.frame(
    street = c("145 Medical Way", "1048 Brown Ave", "999 El Camino"),
    city   = c("Andover", "Hamilton", "El Paso")
    )
  )
```

Here is how the list looks when printed to the console. See how there are two named elements:

-   `hospitals`, a character vector\
-   `addresses`, a data frame of addresses

```{r}
my_list
```

Now we extract, using various methods:

```{r}
my_list[1] # this returns the element in class "list" - the element name is still displayed

my_list[[1]] # this returns only the (unnamed) character vector

my_list[["hospitals"]] # you can also index by name of the list element

my_list[[1]][3] # this returns the third element of the "hospitals" character vector

my_list[[2]][1] # This returns the first column ("street") of the address data frame

```

<!-- ======================================================= -->

### Remove objects {.unnumbered}

You can remove individual objects from your R environment by putting the name in the `rm()` function (no quote marks):

```{r, eval=F}
rm(object_name)
```

You can remove all objects (clear your workspace) by running:

```{r, eval=F}
rm(list = ls(all = TRUE))
```

<!-- ======================================================= -->

<!-- ======================================================= -->

<!-- ======================================================= -->

## Piping (`%>%`)

**Two general approaches to working with objects are:**

1)  **Pipes/tidyverse** - pipes send an object from function to function - emphasis is on the *action*, not the object\
2)  **Define intermediate objects** - an object is re-defined again and again - emphasis is on the object

<!-- ======================================================= -->

### **Pipes** {.unnumbered}

**Simply explained, the pipe operator (`%>%`) passes an intermediate output from one function to the next.**\
You can think of it as saying "then". Many functions can be linked together with `%>%`.

-   **Piping emphasizes a sequence of actions, not the object the actions are being performed on**\
-   Pipes are best when a sequence of actions must be performed on one object\
-   Pipes come from the package **magrittr**, which is automatically included in packages **dplyr** and **tidyverse**
-   Pipes can make code more clean and easier to read, more intuitive

Read more on this approach in the tidyverse [style guide](https://style.tidyverse.org/pipes.html)

Here is a fake example for comparison, using fictional functions to "bake a cake". First, the pipe method:

```{r piping_example_pipe, eval=F}
# A fake example of how to bake a cake using piping syntax

cake <- flour %>%       # to define cake, start with flour, and then...
  add(eggs) %>%   # add eggs
  add(oil) %>%    # add oil
  add(water) %>%  # add water
  mix_together(         # mix together
    utensil = spoon,
    minutes = 2) %>%    
  bake(degrees = 350,   # bake
       system = "fahrenheit",
       minutes = 35) %>%  
  let_cool()            # let it cool down
```

Here is another [link](https://cfss.uchicago.edu/notes/pipes/#:~:text=Pipes%20are%20an%20extremely%20useful,code%20and%20combine%20multiple%20operations) describing the utility of pipes.

Piping is not a **base** function. To use piping, the **magrittr** package must be installed and loaded (this is typically done by loading **tidyverse** or **dplyr** package which include it). You can [read more about piping in the magrittr documentation](https://magrittr.tidyverse.org/).

Note that just like other R commands, pipes can be used to just display the result, or to save/re-save an object, depending on whether the assignment operator `<-` is involved. See both below:

```{r, eval=F}
# Create or overwrite object, defining as aggregate counts by age category (not printed)
linelist_summary <- linelist %>% 
  count(age_cat)
```

```{r}
# Print the table of counts in the console, but don't save it
linelist %>% 
  count(age_cat)
```

**`%<>%`**\
This is an "assignment pipe" from the **magrittr** package, which *pipes an object forward and also re-defines the object*. It must be the first pipe operator in the chain. It is shorthand. The below two commands are equivalent:

```{r, eval=F}
linelist <- linelist %>%
  filter(age > 50)

linelist %<>% filter(age > 50)
```

<!-- ======================================================= -->

### Define intermediate objects {.unnumbered}

This approach to changing objects/dataframes may be better if:

-   You need to manipulate multiple objects\
-   There are intermediate steps that are meaningful and deserve separate object names

**Risks:**

-   Creating new objects for each step means creating lots of objects. If you use the wrong one you might not realize it!\
-   Naming all the objects can be confusing\
-   Errors may not be easily detectable

Either name each intermediate object, or overwrite the original, or combine all the functions together. All come with their own risks.

Below is the same fake "cake" example as above, but using this style:

```{r piping_example_redefine, eval=F}
# a fake example of how to bake a cake using this method (defining intermediate objects)
batter_1 <- left_join(flour, eggs)
batter_2 <- left_join(batter_1, oil)
batter_3 <- left_join(batter_2, water)

batter_4 <- mix_together(object = batter_3, utensil = spoon, minutes = 2)

cake <- bake(batter_4, degrees = 350, system = "fahrenheit", minutes = 35)

cake <- let_cool(cake)
```

Combine all functions together - this is difficult to read:

```{r eval=F}
# an example of combining/nesting mutliple functions together - difficult to read
cake <- let_cool(bake(mix_together(batter_3, utensil = spoon, minutes = 2), degrees = 350, system = "fahrenheit", minutes = 35))
```

<!-- ======================================================= -->

## Key operators and functions {#operators}

This section details operators in R, such as:

-   Definitional operators\
-   Relational operators (less than, equal too..)\
-   Logical operators (and, or...)\
-   Handling missing values\
-   Mathematical operators and functions (+/-, \>, sum(), median(), ...)\
-   The `%in%` operator

<!-- ======================================================= -->

### Assignment operators {.unnumbered}

**`<-`**

The basic assignment operator in R is `<-`. Such that `object_name <- value`.\
This assignment operator can also be written as `=`. We advise use of `<-` for general R use.\
We also advise surrounding such operators with spaces, for readability.

**`<<-`**

If [Writing functions], or using R in an interactive way with sourced scripts, then you may need to use this assignment operator `<<-` (from **base** R). This operator is used to define an object in a higher 'parent' R Environment. See this [online reference](https://stat.ethz.ch/R-manual/R-devel/library/base/html/assignOps.html).

**`%<>%`**

This is an "assignment pipe" from the **magrittr** package, which pipes an object forward and *also re-defines the object*. It must be the first pipe operator in the chain. It is shorthand, as shown below in two equivalent examples:

```{r, eval=F}
linelist <- linelist %>% 
  mutate(age_months = age_years * 12)
```

The above is equivalent to the below:

```{r, eval=F}
linelist %<>% mutate(age_months = age_years * 12)
```

**`%<+%`**

This is used to add data to phylogenetic trees with the **ggtree** package. See the page on [Phylogenetic trees] or this online [resource book](https://yulab-smu.top/treedata-book/).

<!-- ======================================================= -->

### Relational and logical operators {.unnumbered}

Relational operators compare values and are often used when defining new variables and subsets of datasets. Here are the common relational operators in R:

+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Meaning                  | Operator   | Example      | Example Result                                                                                                                                         |
+==========================+============+==============+========================================================================================================================================================+
| Equal to                 | `==`       | `"A" == "a"` | `FALSE` (because R is case sensitive) *Note that == (double equals) is different from = (single equals), which acts like the assignment operator `<-`* |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Not equal to             | `!=`       | `2 != 0`     | `TRUE`                                                                                                                                                 |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Greater than             | `>`        | `4 > 2`      | `TRUE`                                                                                                                                                 |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Less than                | `<`        | `4 < 2`      | `FALSE`                                                                                                                                                |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Greater than or equal to | `>=`       | `6 >= 4`     | `TRUE`                                                                                                                                                 |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Less than or equal to    | `<=`       | `6 <= 4`     | `FALSE`                                                                                                                                                |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Value is missing         | `is.na()`  | `is.na(7)`   | `FALSE` (see page on [Missing data])                                                                                                                   |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Value is not missing     | `!is.na()` | `!is.na(7)`  | `TRUE`                                                                                                                                                 |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+

Logical operators, such as AND and OR, are often used to connect relational operators and create more complicated criteria. Complex statements might require parentheses ( ) for grouping and order of application.

+-------------+-----------------------------------------------------------------------+
| Meaning     | Operator                                                              |
+=============+=======================================================================+
| AND         | `&`                                                                   |
+-------------+-----------------------------------------------------------------------+
| OR          | `|` (vertical bar)                                                    |
+-------------+-----------------------------------------------------------------------+
| Parentheses | `( )` Used to group criteria together and clarify order of operations |
+-------------+-----------------------------------------------------------------------+

For example, below, we have a linelist with two variables we want to use to create our case definition, `hep_e_rdt`, a test result and `other_cases_in_hh`, which will tell us if there are other cases in the household. The command below uses the function `case_when()` to create the new variable `case_def` such that:

```{r eval=FALSE}
linelist_cleaned <- linelist %>%
  mutate(case_def = case_when(
    is.na(rdt_result) & is.na(other_case_in_home)            ~ NA_character_,
    rdt_result == "Positive"                                 ~ "Confirmed",
    rdt_result != "Positive" & other_cases_in_home == "Yes"  ~ "Probable",
    TRUE                                                     ~ "Suspected"
  ))
```

+------------------------------------------------------------------------------------------------+--------------------------------------------+
| Criteria in example above                                                                      | Resulting value in new variable "case_def" |
+================================================================================================+============================================+
| If the value for variables `rdt_result` and `other_cases_in_home` are missing                  | `NA` (missing)                             |
+------------------------------------------------------------------------------------------------+--------------------------------------------+
| If the value in `rdt_result` is "Positive"                                                     | "Confirmed"                                |
+------------------------------------------------------------------------------------------------+--------------------------------------------+
| If the value in `rdt_result` is NOT "Positive" AND the value in `other_cases_in_home` is "Yes" | "Probable"                                 |
+------------------------------------------------------------------------------------------------+--------------------------------------------+
| If one of the above criteria are not met                                                       | "Suspected"                                |
+------------------------------------------------------------------------------------------------+--------------------------------------------+

*Note that R is case-sensitive, so "Positive" is different than "positive"...*

<!-- ======================================================= -->

### Missing values {.unnumbered}

In R, missing values are represented by the special value `NA` (a "reserved" value) (capital letters N and A - not in quotation marks). If you import data that records missing data in another way (e.g. 99, "Missing", or .), you may want to re-code those values to `NA`. How to do this is addressed in the [Import and export] page.

**To test whether a value is `NA`, use the special function `is.na()`**, which returns `TRUE` or `FALSE`.

```{r basics_operators_missing}
rdt_result <- c("Positive", "Suspected", "Positive", NA)   # two positive cases, one suspected, and one unknown
is.na(rdt_result)  # Tests whether the value of rdt_result is NA
```

Read more about missing, infinite, `NULL`, and impossible values in the page on [Missing data]. Learn how to convert missing values when importing data in the page on [Import and export].

<!-- ======================================================= -->

### Mathematics and statistics {.unnumbered}

All the operators and functions in this page are automatically available using **base** R.

#### Mathematical operators {.unnumbered}

These are often used to perform addition, division, to create new columns, etc. Below are common mathematical operators in R. Whether you put spaces around the operators is not important.

| Purpose             | Example in R |
|---------------------|--------------|
| addition            | 2 + 3        |
| subtraction         | 2 - 3        |
| multiplication      | 2 \* 3       |
| division            | 30 / 5       |
| exponent            | 2\^3         |
| order of operations | ( )          |

#### Mathematical functions {.unnumbered}

| Purpose            | Function                              |
|--------------------|---------------------------------------|
| rounding           | round(x, digits = n)                  |
| rounding           | janitor::round_half_up(x, digits = n) |
| ceiling (round up) | ceiling(x)                            |
| floor (round down) | floor(x)                              |
| absolute value     | abs(x)                                |
| square root        | sqrt(x)                               |
| exponent           | exponent(x)                           |
| natural logarithm  | log(x)                                |
| log base 10        | log10(x)                              |
| log base 2         | log2(x)                               |

Note: for `round()` the `digits =` specifies the number of decimal placed. Use `signif()` to round to a number of significant figures.

#### Scientific notation {.unnumbered}

The likelihood of scientific notation being used depends on the value of the `scipen` option.

From the documentation of `?options`: scipen is a penalty to be applied when deciding to print numeric values in fixed or exponential notation. Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than 'scipen' digits wider.

If it is set to a low number (e.g. 0) it will be "turned on" always. To "turn off" scientific notation in your R session, set it to a very high number, for example:

```{r, eval=F}
# turn off scientific notation
options(scipen=999)
```

#### Rounding {.unnumbered}

[***DANGER:*** `round()` uses "banker's rounding" which rounds up from a .5 only if the upper number is even. Use `round_half_up()` from **janitor** to consistently round halves up to the nearest whole number. See [this explanation](https://cran.r-project.org/web/packages/janitor/vignettes/janitor.html#explore-records-with-duplicated-values-for-specific-combinations-of-variables-with-get_dupes)]{style="color: red;"}

```{r}
# use the appropriate rounding function for your work
round(c(2.5, 3.5))

janitor::round_half_up(c(2.5, 3.5))
```

#### Statistical functions {.unnumbered}

[***CAUTION:*** The functions below will by default include missing values in calculations. Missing values will result in an output of `NA`, unless the argument `na.rm = TRUE` is specified. This can be written shorthand as `na.rm = T`.]{style="color: orange;"}

| Objective               | Function           |
|-------------------------|--------------------|
| mean (average)          | mean(x, na.rm=T)   |
| median                  | median(x, na.rm=T) |
| standard deviation      | sd(x, na.rm=T)     |
| quantiles\*             | quantile(x, probs) |
| sum                     | sum(x, na.rm=T)    |
| minimum value           | min(x, na.rm=T)    |
| maximum value           | max(x, na.rm=T)    |
| range of numeric values | range(x, na.rm=T)  |
| summary\*\*             | summary(x)         |

Notes:

-   `*quantile()`: `x` is the numeric vector to examine, and `probs =` is a numeric vector with probabilities within 0 and 1.0, e.g `c(0.5, 0.8, 0.85)`
-   `**summary()`: gives a summary on a numeric vector including mean, median, and common percentiles

[***DANGER:*** If providing a vector of numbers to one of the above functions, be sure to wrap the numbers within `c()` .]{style="color: red;"}

```{r}
# If supplying raw numbers to a function, wrap them in c()
mean(1, 6, 12, 10, 5, 0)    # !!! INCORRECT !!!  

mean(c(1, 6, 12, 10, 5, 0)) # CORRECT
```

#### Other useful functions {.unnumbered}

+----------------------------+-------------------+-------------------------------------------------+
| Objective                  | Function          | Example                                         |
+============================+===================+=================================================+
| create a sequence          | seq(from, to, by) | `seq(1, 10, 2)`                                 |
+----------------------------+-------------------+-------------------------------------------------+
| repeat x, n times          | rep(x, ntimes)    | `rep(1:3, 2)` or `rep(c("a", "b", "c"), 3)`     |
+----------------------------+-------------------+-------------------------------------------------+
| subdivide a numeric vector | cut(x, n)         | `cut(linelist$age, 5)`                          |
+----------------------------+-------------------+-------------------------------------------------+
| take a random sample       | sample(x, size)   | `sample(linelist$id, size = 5, replace = TRUE)` |
+----------------------------+-------------------+-------------------------------------------------+

<!-- ======================================================= -->

### `%in%` {.unnumbered}

A very useful operator for matching values, and for quickly assessing if a value is within a vector or dataframe.

```{r}
my_vector <- c("a", "b", "c", "d")
```

```{r}
"a" %in% my_vector
"h" %in% my_vector
```

To ask if a value is **not** `%in%` a vector, put an exclamation mark (!) **in front** of the logic statement:

```{r}
# to negate, put an exclamation in front
!"a" %in% my_vector
!"h" %in% my_vector
```

`%in%` is very useful when using the **dplyr** function `case_when()`. You can define a vector previously, and then reference it later. For example:

```{r eval=F}
affirmative <- c("1", "Yes", "YES", "yes", "y", "Y", "oui", "Oui", "Si")

linelist <- linelist %>% 
  mutate(child_hospitaled = case_when(
    hospitalized %in% affirmative & age < 18 ~ "Hospitalized Child",
    TRUE                                      ~ "Not"))
```

Note: If you want to detect a partial string, perhaps using `str_detect()` from **stringr**, it will not accept a character vector like `c("1", "Yes", "yes", "y")`. Instead, it must be given a *regular expression* - one condensed string with OR bars, such as "1\|Yes\|yes\|y". For example, `str_detect(hospitalized, "1|Yes|yes|y")`. See the page on [Characters and strings] for more information.

You can convert a character vector to a named regular expression with this command:

```{r}
affirmative <- c("1", "Yes", "YES", "yes", "y", "Y", "oui", "Oui", "Si")
affirmative

# condense to 
affirmative_str_search <- paste0(affirmative, collapse = "|")  # option with base R
affirmative_str_search <- str_c(affirmative, collapse = "|")   # option with stringr package

affirmative_str_search
```

<!-- ======================================================= -->

<!-- ======================================================= -->

<!-- ======================================================= -->

## Errors & warnings

This section explains:

-   The difference between errors and warnings\
-   General syntax tips for writing R code\
-   Code assists

Common errors and warnings and troubleshooting tips can be found in the page on [Errors and help].

<!-- ======================================================= -->

### Error versus Warning {.unnumbered}

When a command is run, the R Console may show you warning or error messages in red text.

-   A **warning** means that R has completed your command, but had to take additional steps or produced unusual output that you should be aware of.

-   An **error** means that R was not able to complete your command.

Look for clues:

-   The error/warning message will often include a line number for the problem.

-   If an object "is unknown" or "not found", perhaps you spelled it incorrectly, forgot to call a package with library(), or forgot to re-run your script after making changes.

If all else fails, copy the error message into Google along with some key terms - chances are that someone else has worked through this already!

<!-- ======================================================= -->

### General syntax tips {.unnumbered}

A few things to remember when writing commands in R, to avoid errors and warnings:

-   Always close parentheses - tip: count the number of opening "(" and closing parentheses ")" for each code chunk
-   Avoid spaces in column and object names. Use underscore ( \_ ) or periods ( . ) instead
-   Keep track of and remember to separate a function's arguments with commas
-   R is case-sensitive, meaning `Variable_A` is *different* from `variable_A`

<!-- ======================================================= -->

### Code assists {.unnumbered}

Any script (RMarkdown or otherwise) will give clues when you have made a mistake. For example, if you forgot to write a comma where it is needed, or to close a parentheses, RStudio will raise a flag on that line, on the right side of the script, to warn you.
